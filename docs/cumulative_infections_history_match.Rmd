---
title: "Cumulative Infections History Match"
author: "Doug McNeall"
date: "6/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Introduction 

This vignette history matches MetaWards using the trajectory of the estimated number of UK cases of COVID-19 through time.

ONS data direct estimates. (put these estimates in a data frame).


5th June 2020
<https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/conditionsanddiseases/bulletins/coronaviruscovid19infectionsurveypilot/5june2020>

28th May 2020
<https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/conditionsanddiseases/bulletins/coronaviruscovid19infectionsurveypilot/28may2020>

21st May 2020
<https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/conditionsanddiseases/bulletins/coronaviruscovid19infectionsurveypilot/england21may2020>

14th May 2020
<https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/conditionsanddiseases/bulletins/coronaviruscovid19infectionsurveypilot/england14may2020>

# ONS cases (absolute numbers in England)
# Incidence rate is new cases per week per 100 people

  start_date end_date cases_med cases_lower95 cases_upper95 prop_med prop_lower95 prop_upper95 new_cases_med new_cases_lower95 new_cases_upper95 incidence_rate
  2020-04-27 2020-05-10 148000 94000 222000 0.27 0.17 0.41 NA NA NA
  2020-05-04 2020-05-17 137000 85000 208000 0.25 0.16 0.38 61000 29000 111000 0.11
  2020-05-11 2020-05-24 133000 62000 250000 0.24 0.11 0.46 54000 34000 86000 0.10
  2020-05-17 2020-05-30 53000 25000 99000  0.10 0.05 0.18 39000 26000 55000 0.07
  
# Also check out Cambridge MRC estimates  
<https://www.mrc-bsu.cam.ac.uk/tackling-covid-19/nowcasting-and-forecasting-of-covid-19/>
<https://www.mrc-bsu.cam.ac.uk/now-casting/>



```{r}

ons <- read.csv("../data/ons_covid_infection_survey.csv", header = TRUE, na.strings = c('NA'))
dat <- read.csv('https://coronavirus.data.gov.uk/downloads/csv/coronavirus-cases_latest.csv')

```




Get England data

```{r}

england <- dat[dat[,'Area.name']=='England', ]

test <- data.frame('Specimen.date' = as.Date(england[,'Specimen.date']), 'Daily.lab.confirmed.cases' = england[,'Daily.lab.confirmed.cases'])

library(tidyverse)
library(lubridate)

weekly_new_cases <- test %>% 
  group_by(week = format(Specimen.date, '%Y-%U')) %>%
  #group_by(year = year(Specimen.date), week = week(Specimen.date)) %>% 
  summarise(weekly_sum = sum(Daily.lab.confirmed.cases))

# manually calculate the date axis for now
week_ax = seq(from = min(as.Date(england[, 'Specimen.date'])), to = max(as.Date(england[, 'Specimen.date'])), by = 7)

ons_midpoints <- as.Date(c("2020-05-03","2020-05-10","2020-05-17","2020-05-24"))
```

```{r, fig.width = 7, fig.height = 6}
plot(week_ax, weekly_new_cases$weekly_sum, ylim = c(0, 100000))
points(ons_midpoints, ons[,'new_cases_med'], col = 'red' )
segments(x0 = ons_midpoints, y0 = ons[,'new_cases_lower95'], x1 = ons_midpoints, y1 = ons[,'new_cases_upper95'])
```


```{r}

#plot(dat$end_date, dat$new_cases_med)
plot(as.Date(england[, 'Specimen.date']), england[, 'Daily.lab.confirmed.cases'])



```


```{r, include=FALSE}

plotLocalCases <- function(area = 'Devon', dat, col = 'skyblue2', ...){
        # 'area' should be a string that names an area of interest
        
        localData <- dat[dat[,'Area.name']==area, ]
        
        da = seq(from = min(as.Date(localData[, 'Specimen.date'])), to = max(as.Date(localData[, 'Specimen.date'])), by = 7)

        
        par(las = 1, mar = c(2.5,4,4,1))
        plot(as.Date(localData[, 'Specimen.date']), localData[, 'Daily.lab.confirmed.cases'],
             xlab = '', ylab = 'cases', main = paste0('Daily lab-confirmed Coronavirus cases in ', area),
             type = 'h', lwd = 5, col = col, bty = 'n', axes = FALSE, ...)
        grid()
        
        axis.Date(1,at=da,labels=format(da,"%d %b"),las=1)
        axis(2)
}

```
 









## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
